---
import Layout from './Layout.astro'
import Card from '@/components/Card.astro'
import SidebarLeft from '@/components/SidebarLeft.astro'
import TableOfContents from '@/components/TableOfContents.astro'
import TagCard from '@/components/TagCard.astro'
import ArchiveList from '@/components/ArchiveList.astro'

import CategoryCard from '@/components/CategoryCard.astro'
import { getCollection } from 'astro:content'
import { expandTags } from '@/utils/tag'
import { getPostCategory } from '@/utils/category'
import { getCreateTime } from '@/utils/time'

interface Props {
  title: string
  description?: string
  postId: string
  headings: any[]
  tags: string[]
}

const { title, description, postId, headings, tags } = Astro.props

// Load related posts
const allPosts = await getCollection('posts')
const publishedPosts = allPosts.filter((post) => !post.data.draft)

const relatedPosts = publishedPosts
  .filter(
    (p) =>
      p.id.replace(/\.md$/, '') !== postId &&
      expandTags(p.data.tags).some((tag) => tags.includes(tag)),
  )
  .sort((a, b) => getCreateTime(b.data) - getCreateTime(a.data))
  .slice(0, 5)
  .map((p) => ({
    id: p.id.replace(/\.md$/, ''),
    title: p.data.title,
    createTime: getCreateTime(p.data),
  }))

// Get recent posts for right sidebar
const recentPosts = publishedPosts
  .sort((a, b) => getCreateTime(b.data) - getCreateTime(a.data))
  .slice(0, 5)
  .map((p) => ({
    id: p.id.replace(/\.md$/, ''),
    title: p.data.title,
    createTime: getCreateTime(p.data),
  }))

// Statistics for tags
const allTags = [
  ...new Set(publishedPosts.flatMap((p) => expandTags(p.data.tags))),
]
const tagCounts = allTags
  .map((tag) => ({
    tag,
    count: publishedPosts.filter((p) => expandTags(p.data.tags).includes(tag))
      .length,
  }))
  .sort((a, b) => b.count - a.count)
  .slice(0, 10)

// Archive statistics
const postsByYear = publishedPosts.reduce(
  (acc, post) => {
    const year = new Date(getCreateTime(post.data)).getFullYear()
    acc[year] = (acc[year] || 0) + 1
    return acc
  },
  {} as Record<number, number>,
)

// Get categories with counts
const categoryCounts = new Map<string, number>()
publishedPosts.forEach((post) => {
  const category = getPostCategory(post)
  categoryCounts.set(category, (categoryCounts.get(category) || 0) + 1)
})

const categories = Array.from(categoryCounts.entries())
  .map(([name, count]) => ({ name, count }))
  .sort((a, b) => b.count - a.count)
  .slice(0, 8)
---

<Layout
  title={title}
  description={description}
>
  <!-- Left Sidebar - ToC -->
  <SidebarLeft class="space-y-6 order-last hidden md:block md:order-first">
    <TableOfContents headings={headings} />

    <CategoryCard categories={categories} />
    <TagCard tags={tagCounts} />
    <ArchiveList archives={postsByYear} />
  </SidebarLeft>

  <!-- Main Content -->
  <main class="space-y-6 flex flex-col order-first md:order-0 min-w-0">
    <slot />
  </main>

  <!-- Right Sidebar - Related Posts -->
  <aside class="space-y-6 max-xl:hidden">
    <div class="sticky top-6 space-y-6">
      {
        relatedPosts.length > 0 && (
          <Card title="相关文章">
            <ul class="space-y-3">
              {relatedPosts.map((post) => (
                <li>
                  <a
                    href={`/post/${post.id}`}
                    class="text-sm line-clamp-2 transition-colors block hover:translate-x-1"
                    style="color: var(--color-t);"
                    onmouseover="this.style.color='var(--color-link)'"
                    onmouseout="this.style.color='var(--color-t)'"
                  >
                    {post.title}
                  </a>
                  <time
                    class="text-xs block mt-1"
                    style="color: var(--color-t-l);"
                  >
                    {new Date(post.createTime).toLocaleDateString('zh-CN', {
                      year: 'numeric',
                      month: '2-digit',
                      day: '2-digit',
                    })}
                  </time>
                </li>
              ))}
            </ul>
          </Card>
        )
      }

      <Card title="最近文章">
        <ul class="space-y-3">
          {
            recentPosts.map((post) => (
              <li>
                <a
                  href={`/post/${post.id}`}
                  class="text-sm line-clamp-2 transition-colors block hover:translate-x-1"
                  style="color: var(--color-t);"
                  onmouseover="this.style.color='var(--color-link)'"
                  onmouseout="this.style.color='var(--color-t)'"
                >
                  {post.title}
                </a>
                <time
                  class="text-xs block mt-1"
                  style="color: var(--color-t-l);"
                >
                  {new Date(post.createTime).toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                  })}
                </time>
              </li>
            ))
          }
        </ul>
      </Card>
    </div>
  </aside>
</Layout>
