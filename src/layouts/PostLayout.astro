---
import Layout from './Layout.astro'

import { expandTags } from '@/utils/tag'
import { getCreateTime } from '@/utils/time'
import { getCollection } from 'astro:content'

interface Props {
  title: string
  description?: string
  postId: string
  headings: any[]
  tags: string[]
}

const { title, description, postId, headings, tags } = Astro.props

// Load related posts
const allPosts = await getCollection('posts')
const publishedPosts = allPosts.filter((post) => !post.data.draft)

const relatedPosts = publishedPosts
  .filter(
    (p) =>
      p.id.replace(/\.md$/, '') !== postId &&
      expandTags(p.data.tags).some((tag) => tags.includes(tag)),
  )
  .sort((a, b) => getCreateTime(b.data) - getCreateTime(a.data))
  .slice(0, 5)
  .map((p) => ({
    id: p.id.replace(/\.md$/, ''),
    title: p.data.title,
    createTime: getCreateTime(p.data),
  }))

// Use consolidated site stats (cached)
import { getSiteStats } from '@/utils/siteStats'
import SidebarLeftForPost from '../components/SidebarLeftForPost.astro'
import SidebarRightForPost from '../components/SidebarRightForPost.astro'
---

<Layout
  title={title}
  description={description}
>
  <!-- Main Content -->
  <main class="space-y-6 flex flex-col order-first md:order-0 min-w-0">
    <slot />
  </main>

  <!-- Left Sidebar - ToC -->
  <SidebarLeftForPost
    class="space-y-6 order-last hidden md:block md:order-first"
    headings={headings}
  />

  <!-- Right Sidebar - Related Posts -->
  <SidebarRightForPost relatedPosts={relatedPosts} />
</Layout>
