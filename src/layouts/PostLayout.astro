---
import Layout from './Layout.astro'
import Card from '@/components/Card.astro'
import CategoryCard from '@/components/CategoryCard.astro'
import { getCollection } from 'astro:content'
import { expandTags } from '@/shared/tag'
import { getPostCategory } from '@/shared/category'
import { getCreateTime } from '@/shared/time'

interface Props {
  title: string
  description?: string
  postId: string
  headings: any[]
  tags: string[]
}

const { title, description, postId, headings, tags } = Astro.props

// Load related posts
const allPosts = await getCollection('posts')
const publishedPosts = allPosts.filter((post) => !post.data.draft)

const relatedPosts = publishedPosts
  .filter(
    (p) =>
      p.id.replace(/\.md$/, '') !== postId &&
      expandTags(p.data.tags).some((tag) => tags.includes(tag)),
  )
  .sort((a, b) => getCreateTime(b.data) - getCreateTime(a.data))
  .slice(0, 5)
  .map((p) => ({
    id: p.id.replace(/\.md$/, ''),
    title: p.data.title,
    createTime: getCreateTime(p.data),
  }))

// Get recent posts for right sidebar
const recentPosts = publishedPosts
  .sort((a, b) => getCreateTime(b.data) - getCreateTime(a.data))
  .slice(0, 5)
  .map((p) => ({
    id: p.id.replace(/\.md$/, ''),
    title: p.data.title,
    createTime: getCreateTime(p.data),
  }))

// Get categories with counts
const categoryCounts = new Map<string, number>()
publishedPosts.forEach((post) => {
  const category = getPostCategory(post)
  categoryCounts.set(category, (categoryCounts.get(category) || 0) + 1)
})

const categories = Array.from(categoryCounts.entries())
  .map(([name, count]) => ({ name, count }))
  .sort((a, b) => b.count - a.count)
  .slice(0, 8)
---

<Layout
  title={title}
  description={description}
>
  <!-- Left Sidebar - ToC -->
  <aside class="space-y-6 order-last hidden md:block md:order-first">
    <div class="sticky top-6 space-y-6">
      <Card title="目录">
        <nav
          class="space-y-1 text-sm overflow-y-auto"
          style="max-height: calc(100vh - 570px);"
        >
          {
            headings.map((heading) => (
              <a
                href={`#${heading.slug}`}
                class="block transition-colors hover:translate-x-1"
                style={`color: var(--color-t); margin-left: ${(heading.depth - 1) * 12}px;`}
                onmouseover="this.style.color='var(--color-link)'"
                onmouseout="this.style.color='var(--color-t)'"
              >
                {heading.text}
              </a>
            ))
          }
        </nav>
      </Card>

      <CategoryCard categories={categories} />
    </div>
  </aside>

  <!-- Main Content -->
  <main class="space-y-6 flex flex-col order-first md:order-0 min-w-0">
    <slot />
  </main>

  <!-- Right Sidebar - Related Posts -->
  <aside class="space-y-6 max-xl:hidden">
    <div class="sticky top-6 space-y-6">
      {
        relatedPosts.length > 0 && (
          <Card title="相关文章">
            <ul class="space-y-3">
              {relatedPosts.map((post) => (
                <li>
                  <a
                    href={`/post/${post.id}`}
                    class="text-sm line-clamp-2 transition-colors block hover:translate-x-1"
                    style="color: var(--color-t);"
                    onmouseover="this.style.color='var(--color-link)'"
                    onmouseout="this.style.color='var(--color-t)'"
                  >
                    {post.title}
                  </a>
                  <time
                    class="text-xs block mt-1"
                    style="color: var(--color-t-l);"
                  >
                    {new Date(post.createTime).toLocaleDateString('zh-CN', {
                      year: 'numeric',
                      month: '2-digit',
                      day: '2-digit',
                    })}
                  </time>
                </li>
              ))}
            </ul>
          </Card>
        )
      }

      <Card title="最近文章">
        <ul class="space-y-3">
          {
            recentPosts.map((post) => (
              <li>
                <a
                  href={`/post/${post.id}`}
                  class="text-sm line-clamp-2 transition-colors block hover:translate-x-1"
                  style="color: var(--color-t);"
                  onmouseover="this.style.color='var(--color-link)'"
                  onmouseout="this.style.color='var(--color-t)'"
                >
                  {post.title}
                </a>
                <time
                  class="text-xs block mt-1"
                  style="color: var(--color-t-l);"
                >
                  {new Date(post.createTime).toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                  })}
                </time>
              </li>
            ))
          }
        </ul>
      </Card>
    </div>
  </aside>
</Layout>
