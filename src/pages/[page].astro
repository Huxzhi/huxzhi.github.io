---
import PostCard from '@/components/Post/PostCard.astro'
import NonPostLayout from '@/layouts/NonPostLayout.astro'
import { expandTags } from '@/utils/tags-util.mjs'
import config from 'urodele.config'
import { getPageList } from './api/post/list'

const page = Number(Astro.params.page)
const allPosts = await getPageList()
const pageSize = config.pagination.size
const posts = allPosts.slice(page * pageSize, (page + 1) * pageSize)
const totalPages = Math.ceil(allPosts.length / pageSize)

export const getStaticPaths = async () => {
  const { default: config } = await import('urodele.config')
  const pageSize = config.pagination.size
  const posts = await getPageList()
  const pages = Math.ceil(posts.length / pageSize)
  return Array.from({ length: pages }, (_, i) => i)
    .filter((v) => v !== 0)
    .map((p) => ({
      params: {
        page: String(p),
      },
    }))
}
---

<NonPostLayout title={config.head.title}>
  {
    posts.map((post) => {
      const postId = post.id.replace(/\.md$/, '')
      const summary = post.intro
      const tags = expandTags(post.tags)

      return (
        <PostCard
          postId={postId}
          title={post.title}
          summary={summary}
          createTime={post.createTime}
          tags={tags}
        />
      )
    })
  }

  <div class="flex justify-center gap-4 mt-8">
    {
      page > 1 && (
        <a
          href={page === 2 ? '/' : `/page/${page - 1}`}
          class="px-4 py-2 rounded-lg transition-colors"
          style="background-color: var(--color-alt);"
        >
          上一页
        </a>
      )
    }

    {
      page < totalPages - 1 && (
        <a
          href={`/page/${page + 1}`}
          class="px-4 py-2 rounded-lg transition-colors"
          style="background-color: var(--color-link); color: #fff;"
        >
          下一页
        </a>
      )
    }
  </div>
</NonPostLayout>
