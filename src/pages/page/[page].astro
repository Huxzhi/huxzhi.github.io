---
import PostCard from '@/components/PostCard.astro'
import NonPostLayout from '@/layouts/NonPostLayout.astro'
import { expandTags } from '@/shared/tag'
import { getCollection } from 'astro:content'
import config from 'urodele.config'
import { getCreateTime } from '../../shared/time'

export async function getStaticPaths() {
  const allPosts = await getCollection('posts')
  const publishedPosts = allPosts
    .filter((post) => !post.data.draft)
    .sort((a, b) => b.data.createTime - a.data.createTime)

  const pageSize = 10
  const pageCount = Math.ceil(publishedPosts.length / pageSize)

  // 从第 2 页开始，因为第 1 页是 index.astro
  return Array.from({ length: pageCount - 1 }, (_, i) => ({
    params: { page: String(i + 2) },
    props: {
      posts: publishedPosts.slice((i + 1) * pageSize, (i + 2) * pageSize),
      currentPage: i + 2,
      totalPages: pageCount,
      totalPosts: publishedPosts.length,
    },
  }))
}

const { posts = [], currentPage, totalPages, totalPosts } = Astro.props

const extractSummary = (body: string | undefined) => {
  if (!body) return ''
  const text = body.replace(/^#.+$/gm, '').replace(/\n+/g, ' ').trim()
  return text.slice(0, 150) + (text.length > 150 ? '...' : '')
}

// 分页逻辑：最多显示 7 个页码
const getPageNumbers = () => {
  if (totalPages <= 7) {
    return Array.from({ length: totalPages }, (_, i) => i + 1)
  }

  if (currentPage <= 3) {
    return [1, 2, 3, 4, 5, null, totalPages]
  }

  if (currentPage >= totalPages - 2) {
    return [
      1,
      null,
      totalPages - 4,
      totalPages - 3,
      totalPages - 2,
      totalPages - 1,
      totalPages,
    ]
  }

  return [
    1,
    null,
    currentPage - 1,
    currentPage,
    currentPage + 1,
    null,
    totalPages,
  ]
}

const pageNumbers = getPageNumbers()
---

<NonPostLayout title={`第 ${currentPage} 页 - ${config.head.title}`}>
  {
    posts.map((post) => {
      const postId = post.id.replace(/\.md$/, '')
      const summary = extractSummary(post.body)
      const tags = expandTags(post.data.tags)

      return (
        <PostCard
          postId={postId}
          title={post.data.title}
          summary={summary}
          createTime={getCreateTime(post.data)}
          tags={tags}
        />
      )
    })
  }

  <!-- Pagination -->
  <nav
    class="flex items-center justify-center gap-2 mt-8"
    aria-label="分页导航"
  >
    {
      currentPage > 1 && (
        <a
          href={currentPage === 2 ? '/' : `/page/${currentPage - 1}`}
          class="px-4 py-2 rounded transition-colors"
          style="background-color: var(--color-alt); color: var(--color-t);"
        >
          ← 上一页
        </a>
      )
    }

    {
      pageNumbers.map((pageNum) =>
        pageNum === null ? (
          <span
            class="px-2"
            style="color: var(--color-t-l);"
          >
            ...
          </span>
        ) : (
          <a
            href={pageNum === 1 ? '/' : `/page/${pageNum}`}
            class="px-4 py-2 rounded transition-colors"
            style={
              pageNum === currentPage
                ? 'background-color: var(--color-link); color: #fff;'
                : 'background-color: var(--color-alt); color: var(--color-t);'
            }
          >
            {pageNum}
          </a>
        ),
      )
    }

    {
      currentPage < totalPages && (
        <a
          href={`/page/${currentPage + 1}`}
          class="px-4 py-2 rounded transition-colors"
          style="background-color: var(--color-alt); color: var(--color-t);"
        >
          下一页 →
        </a>
      )
    }
  </nav>
</NonPostLayout>
