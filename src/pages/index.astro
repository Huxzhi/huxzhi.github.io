---
import NonPostLayout from '@/layouts/NonPostLayout.astro'
import { getAllPosts } from '@/adapter/content'
import { expandTags } from '@/utils/tag'
import { getCreateTime } from '@/utils/time'
import config from 'urodele.config'
import PostCard from '@/components/PostCard.astro'

const allPosts = await getAllPosts()
const publishedPosts = allPosts.filter((post) => !post.data.draft)
const posts = publishedPosts
  .sort((a, b) => getCreateTime(b.data) - getCreateTime(a.data))
  .slice(0, config.pagination.size)

const totalPosts = publishedPosts.length
const hasMorePosts = totalPosts > config.pagination.size

// Extract summary
const extractSummary = (body: string | undefined) => {
  if (!body) return ''
  const text = body.replace(/^#.+$/gm, '').replace(/\n+/g, ' ').trim()
  return text.slice(0, 150)
}
---

<NonPostLayout title={config.head.title}>
  {
    posts.map((post) => {
      const postId = post.id.replace(/\.md$/, '')
      const summary = extractSummary(post.body)
      const tags = expandTags(post.data.tags)

      return (
        <PostCard
          postId={postId}
          title={post.data.title}
          summary={summary}
          createTime={getCreateTime(post.data)}
          tags={tags}
        />
      )
    })
  }

  {
    hasMorePosts && (
      <div class="text-center">
        <a
          href="/page/2"
          class="inline-block px-6 py-2 rounded-lg transition-colors"
          style="background-color: var(--color-link); color: #fff;"
          onmouseover="this.style.backgroundColor='var(--color-link-hover)'"
          onmouseout="this.style.backgroundColor='var(--color-link)'"
        >
          查看更多
        </a>
      </div>
    )
  }
</NonPostLayout>
