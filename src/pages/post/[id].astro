---
import PostLayout from '@/layouts/PostLayout.astro'
import { getPageList } from '@/pages/api/post/list'
import { formatTagDisplay, getLeafTags } from '@/shared/tag'
import { getCollection, getEntry, render } from 'astro:content'
import { expandTags } from '@/shared/tag'

const id = Astro.params.id as string
const entry = await getEntry('posts', id)

if (!entry) {
  return Astro.redirect('/404')
}

const { Content, headings } = await render(entry)
const post = {
  id: entry.id.replace(/\.md$/, ''),
  ...entry.data,
  tags: expandTags(entry.data.tags),
}

const allPosts = await getPageList()

const curIndex = allPosts.findIndex((p) => p.id === post.id)
const prev = allPosts[curIndex + 1]
const next = allPosts[curIndex - 1]

// Get only leaf tags for display (deepest level)
const displayTags = getLeafTags(post.tags)

export const getStaticPaths = async () => {
  const posts = await getCollection('posts')
  return posts.map((p) => ({
    params: {
      id: p.id.replace(/\.md$/, ''),
    },
  }))
}
---

<PostLayout
  title={post.title}
  description={post.intro}
  postId={post.id}
  headings={headings}
  tags={post.tags}
>
  <article>
    <header class="mb-8">
      <h1
        class="text-3xl lg:text-4xl font-bold mb-4"
        style="color: var(--color-title);"
      >
        {post.title}
      </h1>
      <div
        class="flex items-center gap-4 text-sm"
        style="color: var(--color-t-l);"
      >
        <time>
          {
            new Date(post.createTime).toLocaleDateString('zh-CN', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
            })
          }
        </time>
        {
          post.updateTime && (
            <span>
              更新于{' '}
              {new Date(post.updateTime).toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
              })}
            </span>
          )
        }
        {
          displayTags.length > 0 && (
            <span class="lg:hidden flex gap-2">
              {displayTags.map((tag) => (
                <a
                  href={`/tag/${tag}`}
                  class="transition-colors"
                  style="color: var(--color-link);"
                  onmouseover="this.style.color='var(--color-link-hover)'"
                  onmouseout="this.style.color='var(--color-link)'"
                >
                  #{formatTagDisplay(tag)}
                </a>
              ))}
            </span>
          )
        }
      </div>
    </header>

    <div class="prose dark:prose-invert max-w-none">
      <Content />
    </div>

    <!-- Navigation -->
    <nav
      class="mt-12 pt-6"
      style="border-top: 1px solid var(--color-border);"
    >
      <div class="grid grid-cols-2 gap-4">
        {
          prev ? (
            <a
              href={`/post/${prev.id}`}
              class="flex items-center gap-2 text-sm transition-colors"
              style="color: var(--color-t);"
              onmouseover="this.style.color='var(--color-link)'"
              onmouseout="this.style.color='var(--color-t)'"
            >
              <svg
                class="w-5 h-5 flex-shrink-0"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 19l-7-7 7-7"
                />
              </svg>
              <span class="truncate">{prev.title}</span>
            </a>
          ) : (
            <div />
          )
        }

        {
          next ? (
            <a
              href={`/post/${next.id}`}
              class="flex items-center justify-end gap-2 text-sm transition-colors"
              style="color: var(--color-t);"
              onmouseover="this.style.color='var(--color-link)'"
              onmouseout="this.style.color='var(--color-t)'"
            >
              <span class="truncate text-right">{next.title}</span>
              <svg
                class="w-5 h-5 flex-shrink-0"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
            </a>
          ) : (
            <div />
          )
        }
      </div>
    </nav>
  </article>
</PostLayout>
