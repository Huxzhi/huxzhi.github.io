---
import PostLayout from '@/layouts/PostLayout.astro'
import Card from '@/components/Card.astro'
import { getPageList } from '@/pages/api/post/list'
import { getLeafTags } from '@/shared/tag'
import { getCollection, getEntry, render } from 'astro:content'
import { expandTags } from '@/shared/tag'

const id = Astro.params.id as string
const entry = await getEntry('posts', id)

if (!entry) {
  return Astro.redirect('/404')
}

const { Content, headings } = await render(entry)
const post = {
  id: entry.id.replace(/\.md$/, ''),
  ...entry.data,
  tags: expandTags(entry.data.tags),
}

// Extract intro from body for meta description
const intro = entry.body
  ? entry.body.replace(/^#.+$/gm, '').replace(/\n+/g, ' ').trim().slice(0, 150)
  : ''

const allPosts = await getPageList()

const curIndex = allPosts.findIndex((p) => p.id === post.id)
const prev = allPosts[curIndex + 1]
const next = allPosts[curIndex - 1]

// Get only leaf tags for display (deepest level)
const displayTags = getLeafTags(post.tags)

export const getStaticPaths = async () => {
  const posts = await getCollection('posts')
  return posts.map((p) => ({
    params: {
      id: p.id.replace(/\.md$/, ''),
    },
  }))
}
---

<PostLayout
  title={post.title}
  description={intro}
  postId={post.id}
  headings={headings}
  tags={post.tags}
>
  <Card>
    <article>
      <header class="mb-8">
        <div class="flex items-center justify-between mb-4">
          <h1
            class="text-3xl lg:text-4xl font-bold"
            style="color: var(--color-title);"
          >
            {post.title}
          </h1>
          <a
            href={`/edit?path=${post.id}`}
            class="px-4 py-2 text-sm rounded-lg transition-colors flex items-center gap-2"
            style="background-color: var(--color-alt); color: var(--color-t);"
            onmouseover="this.style.color='var(--color-link)'"
            onmouseout="this.style.color='var(--color-t)'"
            title="编辑文章"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
              ></path>
            </svg>
            编辑
          </a>
        </div>
        <div
          class="flex items-center gap-4 text-sm"
          style="color: var(--color-t-l);"
        >
          <time>
            {
              new Date(post.createTime).toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
              })
            }
          </time>
          {
            post.updateTime && (
              <span>
                更新于{' '}
                {new Date(post.updateTime).toLocaleDateString('zh-CN', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                })}
              </span>
            )
          }
          {
            displayTags.length > 0 && (
              <span class="min-h-0 flex gap-2 flex-wrap">
                {displayTags.map((tag) => (
                  <a
                    href={`/tag/${tag}`}
                    class="transition-colors"
                    style="color: var(--color-link);"
                  >
                    #{tag}
                  </a>
                ))}
              </span>
            )
          }
        </div>
      </header>

      <div class="prose dark:prose-invert max-w-none">
        <Content />
      </div>

      <!-- Navigation -->
      <nav
        class="mt-12 pt-6"
        style="border-top: 1px solid var(--color-border);"
      >
        <div class="grid grid-cols-2 gap-4">
          {
            prev ? (
              <a
                href={`/post/${prev.id}`}
                class="flex items-center gap-2 text-sm transition-colors"
                style="color: var(--color-t);"
                onmouseover="this.style.color='var(--color-link)'"
                onmouseout="this.style.color='var(--color-t)'"
              >
                <svg
                  class="w-5 h-5 flex-shrink-0"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 19l-7-7 7-7"
                  />
                </svg>
                <span class="truncate">{prev.title}</span>
              </a>
            ) : (
              <div />
            )
          }

          {
            next ? (
              <a
                href={`/post/${next.id}`}
                class="flex items-center justify-end gap-2 text-sm transition-colors"
                style="color: var(--color-t);"
                onmouseover="this.style.color='var(--color-link)'"
                onmouseout="this.style.color='var(--color-t)'"
              >
                <span class="truncate text-right">{next.title}</span>
                <svg
                  class="w-5 h-5 flex-shrink-0"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>
            ) : (
              <div />
            )
          }
        </div>
      </nav>
    </article>
  </Card>
</PostLayout>
