---
import PostLayout from '@/layouts/PostLayout.astro'
import Card from '@/components/NonPost/Card.astro'

import { getCreateTime, getUpdateTime } from '@/utils/time'
import { getCollection, getEntry } from 'astro:content'
import { queryCollection } from '../../plugins/loader-posts'
import { render } from 'astro:content'

export const prerender = true

export const getStaticPaths = async () => {
  const posts = await queryCollection('posts')
  return posts.map((p) => ({ params: { slug: p.data.slug } }))
}

const slug = Astro.params.slug
const post = await getEntry('posts', slug)

if (!post) {
  return Astro.redirect('/404')
}

const { Content, headings } = await render(post)

// Extract intro from body for meta description

const allPosts = await getCollection('posts')

const curIndex = allPosts.findIndex((p) => p.id === post.id)
const prev = allPosts[curIndex + 1]
const next = allPosts[curIndex - 1]
---

<PostLayout
  title={post.data.title}
  description={post.data.description}
  headings={headings}
  inlinks={post.data.inlinks}
>
  <Card>
    <article>
      <header class="mb-8">
        <div class="flex items-center justify-between mb-4">
          <h1
            class="text-3xl lg:text-4xl font-bold"
            style="color: var(--color-title);"
          >
            {post.data.title}
          </h1>
        </div>
        <div
          class="flex items-center gap-4 text-sm"
          style="color: var(--color-t-l);"
        >
          <time>
            {
              new Date(post.data.created).toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
              })
            }
          </time>
          {
            post.data.updated && (
              <span>
                更新于{' '}
                {new Date(post.data.updated).toLocaleDateString('zh-CN', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                })}
              </span>
            )
          }
          {
            post.data.tags && post.data.tags.length > 0 && (
              <span class="min-h-0 flex gap-2 flex-wrap">
                {post.data.tags.map((tag) => (
                  <a
                    href={`/tag/${tag}`}
                    class="transition-colors"
                    style="color: var(--color-link);"
                  >
                    #{tag}
                  </a>
                ))}
              </span>
            )
          }
        </div>
      </header>

      <div class="prose dark:prose-invert max-w-none">
        <Content />
      </div>

      <!-- Navigation -->
      <nav
        class="mt-12 pt-6"
        style="border-top: 1px solid var(--color-border);"
      >
        <div class="grid grid-cols-2 gap-4">
          {
            prev ? (
              <a
                href={`/post/${prev.id}`}
                class="flex items-center gap-2 text-sm transition-colors"
                style="color: var(--color-t);"
                onmouseover="this.style.color='var(--color-link)'"
                onmouseout="this.style.color='var(--color-t)'"
              >
                <svg
                  class="w-5 h-5 shrink-0"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 19l-7-7 7-7"
                  />
                </svg>
                <span class="truncate">{prev.data.title}</span>
              </a>
            ) : (
              <div />
            )
          }

          {
            next ? (
              <a
                href={`/post/${next.id}`}
                class="flex items-center justify-end gap-2 text-sm transition-colors"
                style="color: var(--color-t);"
                onmouseover="this.style.color='var(--color-link)'"
                onmouseout="this.style.color='var(--color-t)'"
              >
                <span class="truncate text-right">{next.data.title}</span>
                <svg
                  class="w-5 h-5 shrink-0"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>
            ) : (
              <div />
            )
          }
        </div>
      </nav>
    </article>
  </Card>
</PostLayout>
