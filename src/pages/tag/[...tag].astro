---
import NonPostLayout from '@/layouts/NonPostLayout.astro'
import PostCard from '@/components/Post/PostCard.astro'
import { queryCollection } from '@/plugins/loader-posts'
import { expandTags } from '@/utils/tags-util.mjs'

// Rest parameter captures the full path with slashes
const tagPath = Astro.params.tag as string

const posts = (await queryCollection('posts'))
  .map((p) => p.data)
  .filter((post) => (post.tags || []).includes(tagPath))

export const getStaticPaths = async () => {
  const allTags = (await queryCollection('posts'))
    .flatMap((post) => post.data.tags || [])
    .filter((tag, index, self) => self.indexOf(tag) === index)
    .sort()
  return allTags.map((tag) => ({
    params: {
      tag: tag,
    },
  }))
}
---

<script type="module">
  import { mount } from '/src/components/RelativeTime.js'

  mount('data-acc-time')
</script>

<NonPostLayout title={`标签: ${tagPath}`}>
  <div
    class="rounded-lg p-6"
    style="background-color: var(--color-main); box-shadow: var(--shadow-3xl);"
  >
    <h1
      class="text-xl"
      style="color: var(--color-t);"
    >
      分类：{tagPath} 共 {posts.length} 篇文章
    </h1>
  </div>

  {
    posts.map((post) => (
      <PostCard
        postId={post.id}
        title={post.title}
        summary={post.description || ''}
        createTime={post.created}
        tags={expandTags(post.tags)}
      />
    ))
  }

  <div class="text-center mt-8">
    <a
      href="/tag"
      class="inline-block px-6 py-2 rounded-lg transition-colors"
      style="background-color: var(--color-link); color: #fff;"
      onmouseover="this.style.backgroundColor='var(--color-link-hover)'"
      onmouseout="this.style.backgroundColor='var(--color-link)'"
    >
      查看所有标签
    </a>
  </div>
</NonPostLayout>
