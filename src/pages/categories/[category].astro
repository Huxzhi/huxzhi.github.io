---
import NonPostLayout from '@/layouts/NonPostLayout.astro'

import { expandTags } from '@/utils/tags-util.mjs'
import { getCreateTime } from '@/utils/time'
import config from 'urodele.config'
import PostCard from '../../components/Post/PostCard.astro'
import { queryCollection } from '../../plugins/loader-posts'

export const prerender = true

export async function getStaticPaths() {
  const publishedPosts = await queryCollection('posts')

  // 统计所有分类
  const categoryCounts = new Map<string, number>()

  publishedPosts.forEach((post) => {
    const category = post.data.category || '未分类'
    categoryCounts.set(category, (categoryCounts.get(category) || 0) + 1)
  })

  // 为每个分类生成页面
  return Array.from(categoryCounts.keys()).map((category) => ({
    params: { category },
    props: {
      posts: publishedPosts
        .filter((post) => (post.data.category || '未分类') === category)
        .sort((a, b) => getCreateTime(b.data) - getCreateTime(a.data)),
      category,
      count: categoryCounts.get(category) || 0,
    },
  }))
}

const { posts = [], category, count } = Astro.props

const extractSummary = (body: string | undefined) => {
  if (!body) return ''
  const text = body.replace(/^#.+$/gm, '').replace(/\n+/g, ' ').trim()
  return text.slice(0, 150) + (text.length > 150 ? '...' : '')
}
---

<NonPostLayout title={`分类：${category} - ${config.head.title}`}>
  <div class="mb-8">
    <h1
      class="text-3xl font-bold mb-2"
      style="color: var(--color-title);"
    >
      分类：{category}
    </h1>
    <p
      class="text-sm"
      style="color: var(--color-t-l);"
    >
      共 {count} 篇文章
    </p>
  </div>

  {
    posts.map((post) => {
      const postId = post.id.replace(/\.md$/, '')
      const summary = extractSummary(post.body)
      const tags = expandTags(post.data.tags)

      return (
        <PostCard
          postId={postId}
          title={post.data.title}
          summary={summary}
          createTime={getCreateTime(post.data)}
          tags={tags}
        />
      )
    })
  }
</NonPostLayout>
